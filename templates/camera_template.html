<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" >
    <title>TelTelPose</title>
    <!--Bootstrap CSS-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
      
    <!-- Place favicon.ico in the root directory -->
  
    <meta name="theme-color" content="#fafafa">
    <!-- <link type="text/css" rel="stylesheet" href="/css/main.css" /> -->

</head>
<body>
<header class=" bd-header bg-dark py-3  border-dark" >
  <h2 class="text-light" style="text-align:center"><b>TelTelPose</b></h2>
</header>

<div class="container">
  <div class="mt-4">


    {% block content %}
    {% endblock %}

    {% if len > 0 %}
    <div class="d-flex justify-content-around mb-3">
      {% for img in images %}
      <img src = '{{img}}' width="300" height="200" style="border:2px solid">
      {% endfor %}
    </div>
    <div class="d-flex justify-content-around mb-3">
      {% for img in images %}
      <h5>{{loop.index}}ã‚³ãƒç›®</h5>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  <!-- webã‚«ãƒ¡ãƒ©ã®è¡¨ç¤ºéƒ¨åˆ† -->
  <!--------------------------------------------------------------------------------------->
  
  <div class="d-flex justify-content-evenly mb-3">
    <h1 class="display-1" id="count1"></h1>
    <video id="camera" width="60%" style="border:3px solid"></video>
    <h1  class="display-1" id="count2"></h1>
  </div>
  <!--------------------------------------------------------------------------------------->
  <div class="d-flex justify-content-evenly mt-3 mb-3">
    <button type="button" class="all_click btn-secondary">ä¸€åº¦ã«ï¼”ã‚³ãƒæ’®å½±</button>
  </div>
  <!-- å–ã£ãŸå†™çœŸã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ† -->
  <!--------------------------------------------------------------------------------------->
  <div class="d-flex justify-content-around">
    <div class="display">
      <!-- å–ã£ãŸå†™çœŸã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ† -->
        <div>
          <canvas id="picture1" width="300" height="200" style="border:2px solid"></canvas>
        </div>
        <!-- ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ -->
        <form>
          <div class="d-flex justify-content-evenly">
            <button type="button" class="shutter1 btn-secondary">1ã‚³ãƒç›®ã‚’æ’®ã‚Šç›´ã™</button>
          </div>
          
        </form>
      </div>
      
      <div class="display">
      <!-- å–ã£ãŸå†™çœŸã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ† -->
        <div>
          <canvas id="picture2" width="300" height="200" style="border:2px solid"></canvas>
        </div>
        <!-- ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ -->
        <form>
          <div class="d-flex justify-content-evenly">
            <button type="button" class="shutter2 btn-secondary">2ã‚³ãƒç›®ã‚’æ’®ã‚Šç›´ã™</button>
          </div>
        
        </form>
      </div>
      
      <div class="display">
      <!-- å–ã£ãŸå†™çœŸã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ† -->
        <div>
          <canvas id="picture3" width="300" height="200" style="border:2px solid"></canvas>
        </div>
        <!-- ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ -->
        <form>
          <div class="d-flex justify-content-evenly">
            <button type="button" class="shutter3 btn-secondary">3ã‚³ãƒç›®ã‚’æ’®ã‚Šç›´ã™</button>
            
          </div>
          
        </form>
      </div>
      
      <div class="display">
        <!-- å–ã£ãŸå†™çœŸã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ† -->
          <div>
            <canvas id="picture4" width="300" height="200" style="border:2px solid"></canvas>
          </div>
          <!-- ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ -->
          <form>
            <div class="d-flex justify-content-evenly">
              <button type="button" class="shutter4 btn-secondary">4ã‚³ãƒç›®ã‚’æ’®ã‚Šç›´ã™

              </button>
            </div>
          </form>
      </div>
  </div>
  <!--------------------------------------------------------------------------------------->
  
  {% if len==0 %}
  <div hidden >
    <input placeholder="ä½•ã‚’è¡¨ç¾ã—ã¦ã¾ã™ã‹" id="anser" required>
  </div>
  {% endif %}
  {% if len>0 %}
  <div  class="mt-3 d-flex justify-content-evenly">
    <input type="text" placeholder="ãŠé¡Œã¯ä½•ã ã¨æ€ã„ã¾ã—ãŸã‹ï¼Ÿ" class="form-control input-lg" id="anser" required>
  </div>
  {% endif %}

  <div class="d-flex justify-content-evenly mt-4">
      <button class="send_image btn btn-info btn-lg" type="submit">{{ next_user }}</button> 
  </div>

</div>




<!-- ã‚·ãƒ£ãƒƒã‚¿ãƒ¼éŸ³ã®è¨­å®š -->
<!--------------------------------------------------------------------------------------->
<audio id="se" preload="auto">
  <source src="camera-shutter1.mp3" type="audio/mp3">
</audio>
<!-- -------------------------------------------------------------------- -->
<!-- ã“ã“ã‹ã‚‰jsã®å‡¦ç† -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<!-- <script type="text/javascript" src="{{ url_for('static', filename='js/video.js') }}"></script> -->
<script>
function send_img(canvas1,canvas2,canvas3,canvas4){
  //canvas elementã‚’å–å¾—
  // var canvas = document.getElementById('picture');
  //base64ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
  var base641= canvas1.toDataURL('image/jpg');
  var base642 = canvas2.toDataURL('image/jpg');
  var base643 = canvas3.toDataURL('image/jpg');
  var base644 = canvas4.toDataURL('image/jpg');
  var anser   = document.getElementById('anser');
  

  var fData = new FormData();
  fData.append('img1', base641);
  fData.append('img2', base642);
  fData.append('img3', base643);
  fData.append('img4', base644);
  fData.append('anser', anser.value);
  console.log(fData.get('anser'))

// ajaxé€ä¿¡
  $.ajax({
      //ç”»åƒå‡¦ç†ã‚µãƒ¼ãƒãƒ¼ã«è¿”ã™å ´åˆ
      url: "{{url_for('image_save')}}",   
      type: 'POST',
      dataType: 'text',
      data: fData ,
      contentType: false,
      processData: false,
      success: function(data, dataType) {
          //éåŒæœŸã§é€šä¿¡æˆåŠŸæ™‚ã«èª­ã¿å‡ºã•ã‚Œã‚‹ [200 OK æ™‚]
          location.reload();
          console.log('Success', data);
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
          //éåŒæœŸã§é€šä¿¡å¤±æ•—æ™‚ã«èª­ã¿å‡ºã•ã‚Œã‚‹
          console.log('Error : ' + errorThrown);
      }
  });
}

function take_pic(ctx){
  video.pause();  // æ˜ åƒã‚’åœæ­¢
  se.play();      // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼éŸ³
  setTimeout( () => {
  video.play();    // 0.5ç§’å¾Œã«ã‚«ãƒ¡ãƒ©å†é–‹
  }, 500);
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
}

// windowãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¡Œã†å‡¦ç†
window.onload = () => {
  // HTMLå´ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡å®š
const video  = document.querySelector("#camera");
const canvas1 = document.getElementById("picture1");
const canvas2 = document.getElementById("picture2");
const canvas3 = document.getElementById("picture3");
const canvas4 = document.getElementById("picture4");
const odai_predict = document.getElementById('odai')
const se     = document.querySelector('#se');

/** ã‚«ãƒ¡ãƒ©è¨­å®š */
//   éŸ³ã¯ç„¡ã—
// å¤§ãã•200Ã—300
// ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©ã«æŒ‡å®š
const constraints = {
  audio: false,
  video: {
    height: 200,
    width: 300,
    facingMode: "user"   // ãƒ•ãƒ­ãƒ³ãƒˆã‚«ãƒ¡ãƒ©ã‚’åˆ©ç”¨ã™ã‚‹
    // facingMode: { exact: "environment" }  // ãƒªã‚¢ã‚«ãƒ¡ãƒ©ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆ
  }
};

/**
 * ã‚«ãƒ¡ãƒ©ã‚’<video>ã¨åŒæœŸ
 */
navigator.mediaDevices.getUserMedia(constraints)
.then( (stream) => {
  video.srcObject = stream;
  video.onloadedmetadata = (e) => {
    video.play();
  };
})
.catch( (err) => {
  console.log(err.name + ": " + err.message);
});

document.getElementsByClassName("all_click")[0].addEventListener("click", () => {
  document.getElementsByClassName("shutter1")[0].click()
  setTimeout(() => {
    document.getElementsByClassName("shutter2")[0].click();
    setTimeout(() => {
      document.getElementsByClassName("shutter3")[0].click();
      setTimeout(() => {
          document.getElementsByClassName("shutter4")[0].click()
        },5000);
      },5000);
  },5000);

  
});

/**
 * ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³
 */
//   ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
document.getElementsByClassName("shutter1")[0].addEventListener("click", () => {
  count();
  const ctx = canvas1.getContext("2d");

  // æ¼”å‡ºçš„ãªç›®çš„ã§ä¸€åº¦æ˜ åƒã‚’æ­¢ã‚ã¦SEã‚’å†ç”Ÿã™ã‚‹
  //ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã‚‰5ç§’å¾Œã«å‡¦ç†ã‚’è¡Œã†
  setTimeout(() =>{
  video.pause();
  
    // æ˜ åƒã‚’åœæ­¢
  se.play();      // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼éŸ³
  setTimeout( () => {
    video.play();    // 0.5ç§’å¾Œã«ã‚«ãƒ¡ãƒ©å†é–‹
  }, 500);

  // canvasã«ç”»åƒã‚’è²¼ã‚Šä»˜ã‘ã‚‹
  ctx.drawImage(video, 0, 0, canvas1.width, canvas1.height);
},5000);
  // send_img(canvas1)
});


document.getElementsByClassName("shutter2")[0].addEventListener("click", () => {
  count();
  const ctx = canvas2.getContext("2d");

  // æ¼”å‡ºçš„ãªç›®çš„ã§ä¸€åº¦æ˜ åƒã‚’æ­¢ã‚ã¦SEã‚’å†ç”Ÿã™ã‚‹
  setTimeout(() =>{
  video.pause();  // æ˜ åƒã‚’åœæ­¢
  se.play();      // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼éŸ³
  setTimeout( () => {
    video.play();    // 0.5ç§’å¾Œã«ã‚«ãƒ¡ãƒ©å†é–‹
  }, 500);

  // canvasã«ç”»åƒã‚’è²¼ã‚Šä»˜ã‘ã‚‹
  ctx.drawImage(video,0, 0, canvas2.width, canvas2.height);
  // send_img(canvas2)
  },5000);
});


document.getElementsByClassName("shutter3")[0].addEventListener("click", () => {
  count();
  const ctx = canvas3.getContext("2d");

  // æ¼”å‡ºçš„ãªç›®çš„ã§ä¸€åº¦æ˜ åƒã‚’æ­¢ã‚ã¦SEã‚’å†ç”Ÿã™ã‚‹
  setTimeout(() =>{
  video.pause();  // æ˜ åƒã‚’åœæ­¢
  se.play();      // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼éŸ³
  setTimeout( () => {
    video.play();    // 0.5ç§’å¾Œã«ã‚«ãƒ¡ãƒ©å†é–‹
  }, 500);

  // canvasã«ç”»åƒã‚’è²¼ã‚Šä»˜ã‘ã‚‹
  ctx.drawImage(video, 0, 0, canvas1.width, canvas1.height);
  // send_img(canvas3)
  },5000);
});


document.getElementsByClassName("shutter4")[0].addEventListener("click", () => {
  count();
  const ctx = canvas4.getContext("2d");

  // æ¼”å‡ºçš„ãªç›®çš„ã§ä¸€åº¦æ˜ åƒã‚’æ­¢ã‚ã¦SEã‚’å†ç”Ÿã™ã‚‹
  setTimeout(() =>{
  video.pause();  // æ˜ åƒã‚’åœæ­¢
  se.play();      // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼éŸ³
  setTimeout( () => {
    video.play();    // 0.5ç§’å¾Œã«ã‚«ãƒ¡ãƒ©å†é–‹
  }, 500);

  // canvasã«ç”»åƒã‚’è²¼ã‚Šä»˜ã‘ã‚‹
  ctx.drawImage(video, 0, 0, canvas1.width, canvas1.height);
  // send_img(canvas4)
},5000);
});


document.getElementsByClassName("send_image")[0].addEventListener("click", () => {

  send_img(canvas1,canvas2,canvas3,canvas4)
});
};

// ã‚«ãƒ¡ãƒ©ã®ã‚¿ã‚¤ãƒãƒ¼é–¢æ•°
function count(){
  var counter1 = document.getElementById("count1");
  var counter2 = document.getElementById("count2");
  let count = 4;
  const countUp = () =>{
    
    if(count==0){
      counter1.textContent='ğŸ“·';
      counter2.textContent='ğŸ“·';
    }else{
      counter1.textContent=count;
      counter2.textContent=count;
    }
    console.log(count--);
    
    
  }
  const intervalId = setInterval(() =>{
    countUp();
    if(count < 0){
      
      clearInterval(intervalId);//intervalIdã‚’clearIntervalã§æŒ‡å®šã—ã¦ã„ã‚‹
    }
    }, 1000);
    
    
}
</script>
<!----------------------------------------------------------------------------------------------------->
</body>
</html>